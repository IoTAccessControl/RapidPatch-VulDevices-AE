#include "patch_point.h"
#include "iotpatch.h"
#include "patch_service.h"
#include "utils.h"
#include "ebpf.h"
#include "ebpf_allocator.h"
#include "dummy_cve.h"
#include "defs.h"
// #include "include/jit_test.h"

#include <string.h>

struct local_patch {
	const char *cve;
	uint32_t loc;
	const uint8_t *code;
	int code_len;
};

static patch_desc *_desc;
static ebpf_patch *_patch;
static bool is_init = false;
static void setup_cve_install_addr();

#ifdef EBPF_EVA

static uint8_t rt_task_pwm[] = ""
"";

static uint8_t test_cve[] = ""
"\x61\x11\x00\x00\x00\x00\x00\x00\x07\x01\x00\x00\x2f\xf8\xff\xff\x67\x01\x00\x00\x20\x00\x00\x00\x77"
"\x01\x00\x00\x20\x00\x00\x00\xb7\x00\x00\x00\x01\x00\x00\x00\xb7\x02\x00\x00\xb8\x0b\x00\x00\x2d\x12"
"\x01\x00\x00\x00\x00\x00\xb7\x00\x00\x00\x00\x00\x00\x00\x67\x00\x00\x00\x20\x00\x00\x00\x95\x00\x00"
"\x00\x00\x00\x00\x00"
"";

/*
Load patch from local memory or flash
https://github.com/CBackyx/CVE-Reproduction
*/
// static uint8_t zephyr_cve_10063[] = ""
// "\x61\x11\x04\x00\x00\x00\x00\x00\x07\x01\x00\x00\x05\x00\x00\x00\x67\x01\x00\x00\x20\x00\x00\x00\x77"
// "\x01\x00\x00\x20\x00\x00\x00\x69\x11\x00\x00\x00\x00\x00\x00\x18\x00\x00\x00\xea\xff\xff\xff\x00\x00"
// "\x00\x00\x01\x00\x00\x00\x25\x01\x01\x00\xff\xef\x00\x00\xb7\x00\x00\x00\x00\x00\x00\x00\x95\x00\x00"
// "\x00\x00\x00\x00\x00"
// "";

// coap
static uint8_t zephyr_cve_10063[] = ""
"\x61\x11\x04\x00\x00\x00\x00\x00\x07\x01\x00\x00\x05\x00\x00\x00\x67\x01\x00\x00\x20\x00\x00\x00\x77"
"\x01\x00\x00\x20\x00\x00\x00\x69\x12\x00\x00\x00\x00\x00\x00\x18\x01\x00\x00\xea\xff\xff\xff\x00\x00"
"\x00\x00\x00\x00\x00\x00\x25\x02\x01\x00\xff\xef\x00\x00\xb7\x01\x00\x00\x00\x00\x00\x00\xb7\x00\x00"
"\x00\x01\x00\x00\x00\x25\x02\x01\x00\xff\xef\x00\x00\xb7\x00\x00\x00\x00\x00\x00\x00\x67\x00\x00\x00"
"\x20\x00\x00\x00\x4f\x10\x00\x00\x00\x00\x00\x00\x95\x00\x00\x00\x00\x00\x00\x00"
"";

// usb
static uint8_t zephyr_cve_10021[] = ""
"\xb7\x00\x00\x00\x00\x00\x00\x00\x61\x12\x00\x00\x00\x00\x00\x00\xb7\x03\x00\x00\x00\x08\x00\x20\x61"
"\x33\x00\x00\x00\x00\x00\x00\x2d\x23\x04\x00\x00\x00\x00\x00\xb7\x02\x00\x00\x7c\x97\x00\x00\x63\x21"
"\x14\x00\x00\x00\x00\x00\x18\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x95\x00\x00"
"\x00\x00\x00\x00\x00"
"";


static uint8_t zephyr_cve_10062[] = ""
"\xb7\x06\x00\x00\x00\x00\x00\x00\xb7\x03\x00\x00\x01\x00\x00\x00\x61\x11\x00\x00"
"\x00\x00\x00\x00\x79\x12\x00\x00\x00\x00\x00\x00\x71\x21\x00\x00\x00\x00\x00\x00"
"\x67\x01\x00\x00\x38\x00\x00\x00\xc7\x01\x00\x00\x38\x00\x00\x00\x65\x01\x06\x00"
"\xff\xff\xff\xff\xb7\x03\x00\x00\x02\x00\x00\x00\x71\x24\x01\x00\x00\x00\x00\x00"
"\x67\x04\x00\x00\x38\x00\x00\x00\xc7\x04\x00\x00\x38\x00\x00\x00\xb7\x05\x00\x00"
"\x00\x00\x00\x00\x6d\x45\x1e\x00\x00\x00\x00\x00\x57\x01\x00\x00\x7f\x00\x00\x00"
"\x55\x03\x05\x00\x01\x00\x00\x00\x18\x00\x00\x00\xea\xff\xff\xff\x00\x00\x00\x00"
"\x01\x00\x00\x00\x25\x01\x01\x00\xff\xff\xff\x0f\xb7\x00\x00\x00\x00\x00\x00\x00"
"\x95\x00\x00\x00\x00\x00\x00\x00\x71\x24\x01\x00\x00\x00\x00\x00\x57\x04\x00\x00"
"\x7f\x00\x00\x00\x67\x04\x00\x00\x07\x00\x00\x00\x4f\x14\x00\x00\x00\x00\x00\x00"
"\xbf\x41\x00\x00\x00\x00\x00\x00\x07\x06\x00\x00\x01\x00\x00\x00\x65\x06\x2a\x00"
"\x00\x08\x00\x00\x15\x03\xf3\xff\x02\x00\x00\x00\x71\x21\x02\x00\x00\x00\x00\x00"
"\x57\x01\x00\x00\x7f\x00\x00\x00\x67\x01\x00\x00\x0e\x00\x00\x00\x4f\x41\x00\x00"
"\x00\x00\x00\x00\x07\x06\x00\x00\x01\x00\x00\x00\x65\x06\x23\x00\x00\x08\x00\x00"
"\x15\x03\xec\xff\x03\x00\x00\x00\x71\x22\x03\x00\x00\x00\x00\x00\x57\x02\x00\x00"
"\x7f\x00\x00\x00\x67\x02\x00\x00\x15\x00\x00\x00\x4f\x12\x00\x00\x00\x00\x00\x00"
"\xbf\x21\x00\x00\x00\x00\x00\x00\x07\x06\x00\x00\x01\x00\x00\x00\x65\x06\x1b\x00"
"\x00\x08\x00\x00\x05\x00\xe4\xff\x00\x00\x00\x00\xb7\x03\x00\x00\x03\x00\x00\x00"
"\x71\x24\x02\x00\x00\x00\x00\x00\x67\x04\x00\x00\x38\x00\x00\x00\xc7\x04\x00\x00"
"\x38\x00\x00\x00\x07\x06\x00\x00\x01\x00\x00\x00\x65\x06\x14\x00\x00\x08\x00\x00"
"\x65\x04\xdb\xff\xff\xff\xff\xff\xb7\x03\x00\x00\x04\x00\x00\x00\x71\x24\x03\x00"
"\x00\x00\x00\x00\x67\x04\x00\x00\x38\x00\x00\x00\xc7\x04\x00\x00\x38\x00\x00\x00"
"\x07\x06\x00\x00\x01\x00\x00\x00\x65\x06\x0d\x00\x00\x08\x00\x00\x65\x04\xd4\xff"
"\xff\xff\xff\xff\x18\x00\x00\x00\xea\xff\xff\xff\x00\x00\x00\x00\x01\x00\x00\x00"
"\x71\x24\x04\x00\x00\x00\x00\x00\x67\x04\x00\x00\x38\x00\x00\x00\xc7\x04\x00\x00"
"\x38\x00\x00\x00\xb7\x03\x00\x00\x01\x00\x00\x00\x07\x06\x00\x00\x01\x00\x00\x00"
"\x65\x06\x04\x00\x00\x08\x00\x00\x65\x04\xd1\xff\xff\xff\xff\xff\x07\x06\x00\x00"
"\x01\x00\x00\x00\x65\x06\x01\x00\x00\x08\x00\x00\x05\x00\xc8\xff\x00\x00\x00\x00"
"\xb7\x00\x00\x00\x01\x00\x00\x00\x67\x00\x00\x00\x20\x00\x00\x00\x95\x00\x00\x00"
"\x00\x00\x00\x00"
"";


// AMNESIA33_cve_2020_17445
static char AMNESIA33_cve_2020_17445[] = ""
"\x61\x12\x00\x00\x00\x00\x00\x00\x61\x13\x08\x00\x00\x00\x00\x00\x07\x03\x00\x00\x02\x00\x00\x00\x71"
"\x21\x01\x00\x00\x00\x00\x00\x07\x02\x00\x00\x02\x00\x00\x00\x67\x01\x00\x00\x03\x00\x00\x00\x47\x01"
"\x00\x00\x06\x00\x00\x00\x18\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x18\x04\x00"
"\x00\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x71\x25\x01\x00\x00\x00\x00\x00\x07\x05\x00\x00"
"\x02\x00\x00\x00\xbf\x57\x00\x00\x00\x00\x00\x00\x57\x07\x00\x00\xff\x00\x00\x00\x15\x07\x11\x00\x00"
"\x00\x00\x00\xbf\x36\x00\x00\x00\x00\x00\x00\x0f\x76\x00\x00\x00\x00\x00\x00\xbf\x67\x00\x00\x00\x00"
"\x00\x00\x67\x07\x00\x00\x20\x00\x00\x00\x77\x07\x00\x00\x20\x00\x00\x00\x67\x03\x00\x00\x20\x00\x00"
"\x00\x77\x03\x00\x00\x20\x00\x00\x00\x3d\x73\x09\x00\x00\x00\x00\x00\x1f\x51\x00\x00\x00\x00\x00\x00"
"\x57\x05\x00\x00\xff\x00\x00\x00\x0f\x52\x00\x00\x00\x00\x00\x00\xb7\x04\x00\x00\x00\x00\x00\x00\xbf"
"\x15\x00\x00\x00\x00\x00\x00\x57\x05\x00\x00\xff\x00\x00\x00\xbf\x63\x00\x00\x00\x00\x00\x00\xb7\x00"
"\x00\x00\x00\x00\x00\x00\x55\x05\xe6\xff\x00\x00\x00\x00\x4f\x40\x00\x00\x00\x00\x00\x00\x95\x00\x00"
"\x00\x00\x00\x00\x00"
"";

static char AMNESIA33_cve_2020_17445_SFI[] = ""
"\xb7\x08\x00\x00\x00\x00\x00\x00\x61\x12\x00\x00\x00\x00\x00\x00\x61\x13\x08\x00"
"\x00\x00\x00\x00\x07\x03\x00\x00\x02\x00\x00\x00\x71\x21\x01\x00\x00\x00\x00\x00"
"\x07\x02\x00\x00\x02\x00\x00\x00\x67\x01\x00\x00\x03\x00\x00\x00\x47\x01\x00\x00"
"\x06\x00\x00\x00\x18\x00\x00\x00\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00"
"\x18\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x71\x25\x01\x00"
"\x00\x00\x00\x00\x07\x05\x00\x00\x02\x00\x00\x00\xbf\x57\x00\x00\x00\x00\x00\x00"
"\x57\x07\x00\x00\xff\x00\x00\x00\x15\x07\x13\x00\x00\x00\x00\x00\xbf\x36\x00\x00"
"\x00\x00\x00\x00\x0f\x76\x00\x00\x00\x00\x00\x00\xbf\x67\x00\x00\x00\x00\x00\x00"
"\x67\x07\x00\x00\x20\x00\x00\x00\x77\x07\x00\x00\x20\x00\x00\x00\x67\x03\x00\x00"
"\x20\x00\x00\x00\x77\x03\x00\x00\x20\x00\x00\x00\x3d\x73\x0b\x00\x00\x00\x00\x00"
"\x1f\x51\x00\x00\x00\x00\x00\x00\x57\x05\x00\x00\xff\x00\x00\x00\x0f\x52\x00\x00"
"\x00\x00\x00\x00\xb7\x04\x00\x00\x00\x00\x00\x00\xbf\x15\x00\x00\x00\x00\x00\x00"
"\x57\x05\x00\x00\xff\x00\x00\x00\xbf\x63\x00\x00\x00\x00\x00\x00\xb7\x00\x00\x00"
"\x00\x00\x00\x00\x07\x08\x00\x00\x01\x00\x00\x00\x65\x08\x03\x00\x00\x08\x00\x00"
"\x55\x05\xe4\xff\x00\x00\x00\x00\x4f\x40\x00\x00\x00\x00\x00\x00\x95\x00\x00\x00"
"\x00\x00\x00\x00\xb7\x00\x00\x00\x01\x00\x00\x00\x67\x00\x00\x00\x20\x00\x00\x00"
"\x95\x00\x00\x00\x00\x00\x00\x00"
"";

static struct local_patch patch_list[] = {
	// {"my test cve", 0x08002820, test_cve, sizeof(test_cve)},
	// {"my test cve", 0x00009c98, test_cve, sizeof(test_cve)},
	// 080072e0
	{"my test cve", 0x080072e0, test_cve, sizeof(test_cve)},
	{"dynamic patch dummy cve_2020_10062", 0x00009740, zephyr_cve_10062, sizeof(zephyr_cve_10062)},
	{"dynamic patch dummy CVE_2020_17445", 0x00009740, AMNESIA33_cve_2020_17445_SFI, sizeof(AMNESIA33_cve_2020_17445_SFI)},

#ifdef ZEPHYR_OS
	{"zephyr_cve_2020_10063 attack_coap", 0x0000d0be, zephyr_cve_10063, sizeof(zephyr_cve_10063)},
	{"zephyr_cve_2020_10021 attack_usb_mass", 0x00009740, zephyr_cve_10021, sizeof(zephyr_cve_10021)},
	{"zephyr_cve_2020_10062 attack_mqtt", 0x00028370, zephyr_cve_10062, sizeof(zephyr_cve_10062)},
#endif
};

#else
static struct local_patch patch_list[] = {};
#endif // EBPF_EVA

#ifdef ZEPHYR_OS
#include <zephyr.h>
#include <misc/printk.h>
#include <net/coap.h>

// extern int packet_length_decode(struct buf_ctx *buf, u32_t *length);

void setup_cve_install_addr() {
	patch_list[0].loc = (uint32_t) test_dynamic_bug;
	int start = 3;
	patch_list[start].loc = coap_packet_parse;
	// patch_list[3].loc = packet_length_decode;
}
#else
void setup_cve_install_addr() {
	patch_list[0].loc = (uint32_t) test_dynamic_bug;
	patch_list[1].loc = (uint32_t) dynamic_patch_dummy_cve1;
	patch_list[2].loc = (uint32_t) dynamic_patch_dummy_cve2;
	// DEBUG_LOG("set up patch install addr:%p\n", (uint32_t) test_dynamic_bug);
}
#endif // end OS

void show_local_patch_desc() {
	int n = sizeof(patch_list) / sizeof(struct local_patch);
	for (int i = 0; i < n; i++) {
		DEBUG_LOG("%d -> %s\n", i, patch_list[i].cve);
	}
	setup_cve_install_addr();
}

int test_dynamic_bug(int v) {
	if (v > 2000) { // fixed: v > 5000 return -1
		//DEBUG_LOG("test_dynamic_bug-112: %d\n", v);
		return -1;
	}
	//DEBUG_LOG("test_dynamic_bug-: %d\n", v);
	return 0;
}

void verify_patch_trans(uint8_t *code, int code_len) {
	int n = sizeof(zephyr_cve_10062);
	if (n != code_len) {
		DEBUG_LOG("Error Len\n");
	}
	for (int i = 0; i < code_len; i++) {
		if (zephyr_cve_10062[i] != code[i]) {
			DEBUG_LOG("Error at: %d c1:0x%02x c2:0x%02x\n", i, zephyr_cve_10062[i], code[i]);
		}
	}
}

ebpf_patch* read_local_patch(int pid) {
	int n = sizeof(patch_list) / sizeof(struct local_patch);
	if (pid > n) {
		show_local_patch_desc();
		DEBUG_LOG("patch id less than %d\n", n);
		return NULL;
	}
	if (!is_init) {
		_desc = ebpf_calloc(1, sizeof(patch_desc));
		_patch = ebpf_calloc(1, sizeof(ebpf_patch));
		is_init = true;
		init_patch_sys();
		setup_cve_install_addr();
	}

	struct local_patch *pt = &patch_list[pid];
	_desc->type = DynamicPatchPoint;
	_desc->code_len = 0; // code do not save in desc now
	// inst addr should be divided by 4
	_desc->inst_addr = pt->loc;
	_patch->desc = _desc;
	ebpf_vm *vm = _patch->vm;
	if (vm == NULL) {
		vm = init_ebpf_vm(pt->code, pt->code_len);
		// vm->use_jit = false;
	}
	ebpf_vm_set_inst(vm, pt->code, pt->code_len);
	vm->use_jit = true;
	if (vm->use_jit) {
		gen_jit_code(vm);
	}
	_patch->vm = vm;
	load_local_patch_to_ctx(_patch);
	// _patch->is_active = false;
	DEBUG_LOG("load patch %s success!\n", pt->cve);
	return _patch;
}
